\chapter{Design}

\section{Architecture}

The architecture of the system is similar to that of the open-source
\emph{Bacula} project, in that it is organised into separate modules. Figure
\ref{fig:architecture} shows the high-level layout of the design, with arrows
to represent the flow of data.

\begin{figure}[h]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(28,21)
        \put(10,8){\framebox(8,4){backtracserverd}}
        \put(14,8){\vector(0,-1){4}}
        \put(14,4){\vector(0,1){4}}
        \put(10,0){\framebox(8,4){backtracweb}}
        \put(14,16){\vector(0,-1){4}}
        \put(14,12){\vector(0,1){4}}
        \put(10,16){\framebox(8,4){backtracd}}
        \put(18,10){\vector(3,-2){6}}
        \put(24,6){\vector(-3,2){6}}
        \put(24,4){\umlDatabaseLbl{DB}}
        \put(18,2){\vector(3,2){6}}
        \put(24,6){\vector(-3,-2){6}}
        \put(0,4.5){\framebox(6,3){Storage}}
        \put(6,6){\vector(1,1){4}}
        \put(10,10){\vector(-1,-1){4}}
        \put(6,6){\vector(1,-1){4}}
        \put(0,12){\umlRaid}
        \put(3,7.5){\vector(0,1){4.5}}
        \put(3,12){\vector(0,-1){4.5}}
    \end{picture}
    \caption{System architecture diagram}
    \label{fig:architecture}
\end{figure}

At the centre of the system is the server d{\ae}mon, \emph{backtracserverd}.
It is this program that maintains a connection to the client d{\ae}mon,
\emph{backtracd}, which is installed and running on each protected client.

The server d{\ae}mon also has access to a database, which is used to store not
only the meta-data relating to files protected by the system, but also to the
hosts that it protects. This database is called the \emph{catalog}.

The \emph{storage} subsystem provides an interface for the server d{\ae}mon to
read and write files to the physical disk, whilst not explicitly choosing their
location or name. This level of abstraction provides extensibility, should
a future implementation change be desired (for example, cloud storage).

The web interface (denoted as \emph{backtracweb} in figure
\ref{fig:architecture}) allows the administrator to manage and monitor all
aspects of the backup system. The application has read and write access to the
database so clients can be added or altered, and existing clients can be
inspected. Also, read-only access to the storage interface is permitted,
allowing the administrator to download files from the archive through the web
browser.

\section{Catalog}

The catalog provides the facility to store meta-data regarding the files that
are backed up. This meta-data includes the size of the file, when it was backed
up, and the last modified time of the file itself.

The structure of the relational model allows a tree structure to be
constructed, representing the filesystem on the client. An \verb!Item! is
a file or folder, which has a name and an optional parent attribute. If no
parent is present, then the item must be at the top-level.

A number of \verb!Version!s can be associated with each filesystem item. Each
of these represents a version of the related item on the client, which has been
protected and is stored in the archive. A version has a unique identifier,
which can be used to retrieve the associated file from the storage subsystem.

Figure \ref{fig:erd} shows the entity-relationship diagram for the catalog
database.

\begin{figure}
    \begin{center}
        \input{erd}
    \end{center}
    \caption{Entity-relationship diagram for the catalog}
    \label{fig:erd}
\end{figure}

The database also has the facility for storing information regarding the hosts
that are protected by the system. Each \verb!Client! is attributed with an
encryption key, which can be used to encrypt the archived files for that host
(and indeed the network communication with it). Two flags are also available,
for signifying whether the client is \emph{authorized}, and whether it is
\emph{active} (i.e. should be protecting changed files).

As the system is designed to be fully configured from the web interface, the
database also provides the ability to store the directories that should be
protected on a given client. This is represented by the \verb!File Path!
entity, which has only one attribute (the path to be protected), and a link to
the client with which it is associated.

Finally, to record the status of each client---including current connection
status and a timestamp recording the last connection to the server---the
catalog includes a \verb!Status! entity. The relationship between \verb!Client!
and \verb!Status! is a one-to-one relationship, preventing a status-update from
overwriting configuration changes that are in progress.

\section{Storage}

The storage subsystem provides a purposefully restrictive interface for the
server to archive and retrieve files on the filesystem. To archive a file,
a \emph{path} must be specified. A \emph{version ID} is then generated by the
storage subsystem, which allows the server to identify that particular version
of the given file---and then retrieve it when necessary.

To retrieve a file from the archive, both the \emph{path} and the \emph{version
ID} must be specified. The requested version of the given file will then be
accessible, in a read-only manner.

The storage subsystem gives the server code a way of storing files and their
associated versions, without needing to decide (or indeed, record) where on the
filesystem they are located. The server simply needs to record the unique
version identifier which is used to retrieve a particular version of a given
file.
