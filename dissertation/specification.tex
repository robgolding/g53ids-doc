\chapter{Specification}

This Software Requirements Specification (SRS) was produced with the backing of
\textbf{Servat Ltd.}, of Nottingham.

Servat is primarily an accounting system provider, installing and maintaining
software such as DataFile, Aqilla and SAP for their clients. They also resell
a remote backup service to their customers, based on the \emph{Vembu StoreGrid}
system. This puts the company in an ideal position to offer advice for this
project.

\section{Overview}

\emph{Backtrac Backup System} is an open-source backup system for small to
medium-sized installations, which focuses on version control for individual
files. The system is comprised of three main components: the \emph{server} (of
which there is one per installation), the \emph{client} (of which there may be
many) and the \emph{web interface} (accompanying the server).

The clients are the computers which contain important data, to be protected by
the system. This data is transferred over the network, and stored on the
server.

The administrator can access the backups via a web interface, which allows him
or her to browse the files that have been archived for all protected clients.

\section{System Context}

The system will have only minimal interaction with other systems, and all
aspects of the system itself will be self-contained. A dedicated database of
user authentication information will be maintained, meaning that external
factors will not affect the ability of the administrator(s) to access backups.

It is envisaged that the backup server will run on a dedicated computer, with
plentiful storage (ideally in a RAID configuration to guard against disk
failures).

\section{User Requirements}

\subsection{Scenarios}

David is a 39-year-old IT manager for a small construction company based in
Nottingham. The company employs a total of 13 administration staff, whose jobs
mostly involve scheduling work and managing plans for projects. David is the
only person managing the network.

The plans are stored in digital format on a file server in the company's office
building. The server is also used for storing user documents, and runs on
Ubuntu Server 10.04 LTS (Long-Term Support).

David backs up the server to a tape drive every weekend, and has to remember to
take the previous week's tape home for security. Being the only IT person at
the company, David is very busy and does not have time to test the backup very
often, so this has not been done for over a year.

Clients can either email plans to the company, or send them via fax. They are
then transferred to the server, so that all employees can access them in
a central location. Updated plans are sent in frequently, and it is normal for
a project to undergo 5 revisions before work starts. Because the backup only
runs once a week, however, previous versions are often left out of the
backup---as employees tend to overwrite the file instead of keeping both
versions. This means that it is often impossible to access earlier revisions of
a project's plan, and data is at risk of being lost before a backup is
completed at the weekend.

David realises this issue, and installs \emph{Backtrac Backup System} on
a spare computer, adding a 1TB hard drive for backups. He installs the client
application on the file server, and configures it to backup the main shared
directory. The first time the client is started, it performs a full backup of
the share. After this, files are kept up-to-date so that new versions are
backed up immediately.

\section{System Architecture}

The system will be composed of three major parts, which operate independently
of one another:

\begin{itemize}
    \item The backup server
    \item The backup client
    \item The backup server web interface
\end{itemize}

Figure \ref{fig:spec-architecture} shows how these components interact. It
shows that the server acts as a central communication ``hub'', providing the
single point of contact for the client application, and serving as the backend
service for the web interface.

\begin{figure}[h]
    \setlength{\unitlength}{0.14in}
    \centering
    \begin{picture}(28,15)
        \put(2,5){\framebox(10,3){Server}}
        \put(18,10){\framebox(10,3){Client}}
        \put(18,0){\framebox(10,3){Web Interface}}

        \put(12,6.5){\line(6,5){6}}
        \put(12,6.5){\line(6,-5){6}}
    \end{picture}
    \caption{System architecture}
    \label{fig:spec-architecture}
\end{figure}

\subsection{Server}

The backup server is the program which will accept incoming connections from
backup clients, and store the archived files on the server's hard disk(s).  It
will also maintain an up-to-date catalog of all protected files, which can be
accessed by an administrator via the web interface.

\subsubsection{Meta Data}

The server will allow clients to check whether a local file has been modified,
by comparing the file's meta-data to that stored in the catalog. This meta-data
may consists of any or all of the attributes defined in table
\ref{tab:meta-data}.

\begin{table}[h]
    \centering
    \begin{tabular}{| l | l |} \hline
        Field       & Meaning                                       \\ \hline
        size        & File size in bytes                            \\ \hline
        mtime       & File modification time stamp                  \\ \hline
        inode       & The inode number of the file                  \\ \hline
        hash        & A hash (or checksum) of the file's contents   \\ \hline
    \end{tabular}
    \caption{File meta-data}
    \label{tab:meta-data}
\end{table}

This information may then be used to determine whether the file needs to be
archived on the server, or if the current version of the archive is up-to-date.

\subsubsection{Current State}

To allow the client to compare the current file system state with that of the
most up-to-date backup, the server will also allow clients to retrieve the
state of the catalog at the present moment in time. This ``state'' need not
include the meta-data of the archived files, but only their path names---as the
previously mentioned check will be performed to determine whether a backup is
required given that a file exists. The main purpose of this operation is to
notify the server of any files which have been deleted on the client file
system, but still remain in the catalog. This may be as a result of the client
program being stopped for some period of time.

\subsubsection{File Transfer}

Once it has been determined that a file must be re-archived (i.e. the file
system contains a more up-to-date version than the backup archive), it will be
transferred from the client to the server. The server will then store this file
in the archive, and record the meta-data in the catalog.

\subsection{Client}

The client will communicate solely with the server, and will be unable to
access the other parts of the system directly. This will provide not only
security, but should also encourage abstraction when the implementation is
developed to meet this specification.

The client will attempt to connect to the server which is specified in
a configuration file, and authenticate to it with a given secret key. Before
the client can connect, it must be added to the server by an administrator and
configured with said key.

\subsubsection{Meta Data}

To determine whether or not a given file needs to be archived, the client will
query the server for this information. This query may contain any or all of the
attributes in Table \ref{tab:meta-data}.

\subsubsection{Startup Protocol}

When the client program is initially started, it will perform a full scan of
the directories which are configured to be backed up. This configuration
information will be stored on the server, and must be retrieved before the
client can begin backing up files.

Each file will be checked against the archive, to see if a backup is required.
Also, the current state of the file system will be checked, so as to notify the
server of any deletions that have occurred whilst the client was stopped.

\subsubsection{Continuous Backup}

Once started, the client will provide continuous protection for files that are
changed within protected directories on the client computer. If a file changes
on disk, it will be archived within a reasonable amount of time of that change
(i.e. less than one minute). The client program will not scan the protected
directories repeatedly to determine whether a file has changed, as this is
extremely inefficient (especially for large file systems).

\subsubsection{File Transfer}

If a server query indicates that a file is in need of archiving, the file will
be transferred to the server and archived.

\subsection{Web Interface}

The purpose of the web interface is to give the administrator(s) access to the
data stored in the catalog, and to configure the system. The web interface
shall run atop a dedicated web server, and will therefore not be dependent on
any pre-installed web server software (Apache, nginx, etc.)

\subsubsection{Authentication}

The web interface will be accessible via an authenticated username and
password, provided by the system administrator. No screen will be available to
a user unless they are logged in with these credentials. Instead, the login
screen will be presented to an unauthenticated user, before they may proceed.

\subsubsection{Dashboard}

The ``home'' screen of the web interface will present the user with
a dashboard, showing important system statistics and recently occurred events.

\begin{quote}
    Note: events are explained in more detail later on in this section.
\end{quote}

The dashboard will give the administrator an instant overview of the backup
system, including the following information:

\begin{itemize}
    \item Disk usage on the backup server
    \item Backup catalog size
    \item Catalog size history (i.e. a graph showing size over time)
    \item Recent events throughout the system
\end{itemize}

\subsubsection{Clients}

The backup clients will be configured by the administrator via the web
interface. There are a number of different options that will be configurable
for each client, which include (but are not limited to):

\begin{itemize}
    \item Hostname
    \item Secret authentication key (required for the client to connect)
    \item Paths to be protected
    \item Excluded files/folders
\end{itemize}

The client program on a given protected host will not be able to connect to the
server until it has been added to the system by an administrator.

\subsubsection{Catalog}

To provide access to data in the data in the catalog, the web interface will
present the administrator with a list of clients that are present. Once
a client has been selected, the files and folders that are present on the root
of that client will be displayed. The administrator will then be able to
``drill-down'' into each successive directory, to reach the desired location.

Deleted files will not be shown by default, but an option to show them will be
available so that accidentally deleted files can be recovered.

\subsubsection{Events}

The system will record the events which occur on each backup client, and
display these events in the web interface. Each event will have an associated
``time of occurrence'', and will be linked with the file to which it relates in
the catalog. An event may be representative of one of the following actions:

\begin{itemize}
    \item File created
    \item File modified
    \item File deleted
\end{itemize}

\subsubsection{Configuration}

The web interface will also provide access to the main configuration for the
system. This includes options such as globally excluded files (i.e. temporary
files that occur on all clients) which should never be archived, and other
system-wide preferences.

\section{System Requirements}

\subsection{Functional Requirements}

\begin{enumerate}

\renewcommand{\theenumi}{\arabic{enumi}}
\renewcommand{\labelenumi}{\textsc{FuncReq}$\theenumi$.}

\subsubsection{Architecture}

    \item \emph{There shall be only one server (and accompanying web interface)
        per system installation.}
    \item \emph{There may be more than one client per installation, with no set
        maximum number.}
    \item The web interface shall be ``loosely coupled'' from the rest of the
        system, and it's state shall not affect the efficacy of the server or
        client(s) at all.
    \item The client shall communicate only with the server, and not with the
        web interface in any way.
    \item The server application and web interface shall both access a shared
        database, containing the catalog and system configuration.

\subsubsection{Server}

    \item \emph{The server application shall provide a networked daemon,
        listening for connections from multiple clients.}
    \item \emph{The server shall maintain a catalog, containing the
        file system meta-data for each file in the backup archive, and every
        version thereof. The meta-data may contain any or all of the fields
        specified in Table \ref{tab:meta-data}.}
    \item The server shall store archived files from all clients in
        a pre-defined location on the file system, in an organised manner
        to allow any past version of a file to be retrieved.
    \item The server shall allow clients to perform the following operations:
        \begin{enumerate}
            \item Query a file's meta-data in the catalog (to determine if
                a file is up-to-date or not)
            \item Create an item in the catalog (i.e. an empty file or
                directory)
            \item Transfer a file to the archive (storing a new version along
                with it's meta-data in the catalog)
            \item Restore any given version of a file from the archive
            \item Signify that a file has been deleted
        \end{enumerate}
    \item When a client archives a newly created file to the server, it's meta
        data shall be recorded in the catalog, and an initial version of that
        file shall be created in the catalog.
    \item When an existing file is re-archived (due to a modification on the
        client, for example), a new version shall be created and associated
        with that file. The updated meta-data shall be recorded and linked to
        the new version in the catalog.
    \item When a file is deleted, this action shall be recorded in the catalog.
        The file shall not be deleted from the archive, so that it may be
        restored later.

\subsubsection{Client}

    \item \emph{The client application shall connect to the server via it's
        address as specified in a configuration file. It shall authenticate
        itself to the server using a secret key, also specified in
        a configuration file.}
    \item \emph{The client application shall replicate files in protected
        directories to the server.}
    \item \emph{The client shall perform a scan of the file system on startup,
        archiving any files which are not up-to-date and signifying the
        deletion any files which are no longer present. To do this, the client
        shall query the server for a list of files that are present according
        to the catalog, comparing this to the actual state of the file system.}
    \item The client application shall not store any meta-data information on
        the protected host. The server shall hold the only copy of the catalog.
    \item The client shall query the server to check if a file requires
        re-archiving whenever this may be the case (i.e. on startup, and on
        file modification). The file shall only be re-archived if the meta-data
        differs from the latest version in the catalog (i.e. the file on the
        client is more up-to-date than that in the backup archive). The query
        may contain any or all of the fields specified in Table
        \ref{tab:meta-data}.
    \item The client shall provide ``continuous'' file system protection whilst
        is it running, backing up files as soon as they are created or
        modified, and signifying the deletion of files immediately after they
        are removed. This shall not be achieved by ``polling'' the file system
        periodically to detect changes, as this is inefficient.

\subsubsection{Web Interface}

    \item \emph{The web interface shall allow the administrator to add and
        remove backup clients from the system.}
    \item \emph{The web interface shall allow the administrator to browse the
        catalog, and download or restore a file from the archive.}
    \item The web interface shall run independently of any other software,
        including the server daemon. It shall therefore not require any web
        server software to be installed (such as Apache, nginx, lighttpd, etc.)
    \item The web interface shall provide an ``events'' view, which shall allow
        the administrator to see which files have changed and when.
    \item The web interface shall provide a ``dashboard'' overview of the
        backup system, which shall include:
        \begin{enumerate}
            \item A graph showing the size of the archive over time.
            \item A meter showing disk utilization on the file system
                containing the archive.
        \end{enumerate}
    \item The web interface shall allow the administrator to add a new client
        to the system, defining the following attributes:
        \begin{enumerate}
            \item Hostname, which is used to uniquely identify the client
            \item Secret key, which is used to authenticate the client when it
                connects to the server
            \item Protected directories, which will be backed up by the client
                application
            \item Ignored files/directories (in ``glob'' format) which should
                not be archived by the client
        \end{enumerate}
    \item The web interface shall allow the administrator to modify an existing
        client, updating any or all of the attributes on that client
    \item The web interface shall allow the administrator to delete a client,
        along with all related catalog entries and archived data
    \item The web interface shall allow the administrator to browse the catalog
        for any client in the system, and perform the following operations:
        \begin{enumerate}
            \item Drill-down through the directory structure to reach a given
                file
            \item View deleted files/folders in the selected directory
            \item Download an archived file to the local computer
            \item Restore an archived file to it's original location on the
                client
            \item Restore an archived file to a different location on the
                client
            \item Restore an archived file to a specified location on
                a different client (i.e. transfer the file to another client)
        \end{enumerate}
    \item The web interface shall allow the administrator to view detailed
        information about a selected file in the catalog, including:
        \begin{enumerate}
            \item The client on which the file resides (or resided), and it's
                full path
            \item The file's version history
            \item The file's size (at present, and for each version in it's
                history)
            \item When the file was last modified
        \end{enumerate}

\end{enumerate}

\subsection{Non-Functional Requirements}

\begin{enumerate}

\renewcommand{\theenumi}{\arabic{enumi}}
\renewcommand{\labelenumi}{\textsc{NFuncReq}$\theenumi$.}

\subsubsection{Performance Requirements}

    \item The system shall be able to backup large directory structures,
        containing 10,000 or more files/folders.
    \item The system shall return search results within 2 seconds.

\subsubsection{Safety Requirements}

    \item The system shall require user confirmation for delete operations.
    \item The system shall perform automatic backups of the catalog to protect
        against hardware/software failure.

\subsubsection{Security Requirements}

    \item User passwords shall be stored by the system using a cryptographic
        hash.
    \item The web interface shall be accessible only via HTTPS, to ensure that
        sensitive user data cannot be intercepted.
    \item The client shall communicate with the server using an encrypted
        connection, to protect sensitive data in transit.

\subsubsection{Usability Requirements}

    \item The system shall provide a clear and well-structure help system.
    \item The system shall provide ``tool tips'' when hovering over elements
        wherever appropriate.
    \item The system shall provide informative error messages where necessary.
    \item The system shall be intuitive and easy-to-use.

\end{enumerate}

\section{System Models}

\subsection{Server}

\subsubsection{Receiving a file}

When the server receives a file from a client, it should first check to see if
that file exists in the catalog. If it does not, then it should be created.
A new version should then be created to store the meta-data of the incoming
file. The file should then be archived to the disk, and it's location stored in
the catalog with the newly created version. Finally, an event should be created
to record the operation. Figure \ref{fig:receive-file} depicts this process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(28,17)
        \put(1,14){\circle*{1}}
        \put(5,14){\umlDiamond}
        \put(1,14){\vector(1,0){4}}
        \put(6,13){\vector(0,-1){4}}
        \put(8,14.5){[exists in catalog]}
        \put(7,14){\line(1,0){5}}
        \put(0,11){[doesn't exist]}
        \put(6,7.5){\oval(8,3)}
        \put(3.9,7.2){Create item}
        \put(6,6){\vector(0,-1){2}}
        \put(6,2.5){\oval(8,3)}
        \put(2.2,2.2){Create new version}
        \put(12,14){\line(0,-1){11.5}}
        \put(12,2.5){\vector(-1,0){2}}
        \put(6,1){\line(0,-1){1}}
        \put(6,0){\line(1,0){14}}
        \put(20,0){\vector(0,1){1}}
        \put(20,2.5){\oval(8,3)}
        \put(17.5,2.2){Archive file}
        \put(20,4){\vector(0,1){2}}
        \put(20,7.5){\oval(8,3)}
        \put(17.1,7.2){Store location}
        \put(20,9){\vector(0,1){2}}
        \put(20,12.5){\oval(8,3)}
        \put(17.5,12.2){Create event}
        \put(24,12.5){\vector(1,0){2}}
        \put(27,12.5){\circle*{1}}
        \put(27,12.5){\circle{2}}
    \end{picture}
    \caption{Receiving a file}
    \label{fig:receive-file}
\end{figure}

\subsubsection{Deleting a file}

When a client signifies that a file has been deleted, the server should again
check to see if the file exists in the catalog. If so, the file should be
marked as deleted and an event created to record the operation. Otherwise, no
action should be taken. Figure \ref{fig:delete-file} depicts this process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(28,17)
        \put(1,14){\circle*{1}}
        \put(5,14){\umlDiamond}
        \put(1,14){\vector(1,0){4}}
        \put(6,13){\line(0,-1){10.5}}
        \put(6,2.5){\vector(1,0){14}}
        \put(0,11){[doesn't exist]}
        \put(7,14){\line(1,0){10}}
        \put(8,14.5){[exists in catalog]}
        \put(21,14){\oval(8,3)}
        \put(18.3,13.7){Mark deleted}
        \put(21,12.5){\vector(0,-1){4}}
        \put(21,7){\oval(8,3)}
        \put(18.3,6.7){Create event}
        \put(21,5.5){\vector(0,-1){2}}
        \put(21,2.5){\circle*{1}}
        \put(21,2.5){\circle{2}}
    \end{picture}
    \caption{Deleting a file}
    \label{fig:delete-file}
\end{figure}

\subsection{Client}

\subsubsection{Directory Created}

When a new directory is created within a currently protected directory, the
client application should simply notify the server. Figure
\ref{fig:directory-created} depicts this process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(20,8)
        \put(1,4){\circle*{1}}
        \put(1,4){\vector(1,0){4}}
        \put(9,4){\oval(8,3)}
        \put(6.3,3.7){Notify Server}
        \put(13,4){\vector(1,0){4}}
        \put(18,4){\circle*{1}}
        \put(18,4){\circle{2}}
    \end{picture}
    \caption{Directory created}
    \label{fig:directory-created}
\end{figure}

\subsubsection{File Deleted}

When a file under a protected directory is deleted, the client application
should simply notify the server. Figure \ref{fig:file-deleted} depicts this
process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(20,8)
        \put(1,4){\circle*{1}}
        \put(1,4){\vector(1,0){4}}
        \put(9,4){\oval(8,3)}
        \put(6.3,3.7){Notify Server}
        \put(13,4){\vector(1,0){4}}
        \put(18,4){\circle*{1}}
        \put(18,4){\circle{2}}
    \end{picture}
    \caption{File deleted}
    \label{fig:file-deleted}
\end{figure}

\subsubsection{File Updated}

When a file is updated, the client should first query the server with the
file's meta-data to determine whether a backup is required. If so, the client
should transfer the file to the server. Otherwise, no action should be taken.
Figure \ref{fig:file-updated} depicts this process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(28,10)
        \put(1,7){\circle*{1}}
        \put(1,7){\vector(1,0){3}}
        \put(8,7){\oval(8,3)}
        \put(5.3,6.7){Query Server}
        \put(12,7){\vector(1,0){2}}
        \put(14,7){\umlDiamond}
        \put(16,7){\vector(1,0){10}}
        \put(16.5,7.5){[backup not required]}
        \put(15,6){\vector(0,-1){3}}
        \put(15.5,4.5){[backup required]}
        \put(15,1.5){\oval(8,3)}
        \put(12.3,1.2){Transfer File}
        \put(19,1.5){\line(1,0){8}}
        \put(27,1.5){\vector(0,1){4.5}}
        \put(27,7){\circle*{1}}
        \put(27,7){\circle{2}}
    \end{picture}
    \caption{File updated}
    \label{fig:file-updated}
\end{figure}

\subsubsection{Startup Protocol}

On startup, the client application should scan each protected directory. Every
file encountered should be queried to determine if a backup is required, and if
so, it should be transferred to the server. Figure \ref{fig:startup-protocol}
depicts this process.

\begin{figure}[H]
    \setlength{\unitlength}{0.14in}
    \centering
    \footnotesize
    \begin{picture}(28,17)
        \put(1,11){\circle*{1}}
        \put(1,11){\vector(1,0){4}}
        \put(5,11){\umlDiamond}
        \put(6,12){\vector(0,1){3}}
        \put(6.5,13.2){[no files remaining]}
        \put(6,16){\circle*{1}}
        \put(6,16){\circle{2}}
        \put(7,11){\vector(1,0){10}}
        \put(9,11.5){[files remaining]}
        \put(21,11){\oval(8,3)}
        \put(18.1,10.7){Scan Next File}
        \put(21,9.5){\vector(0,-1){2}}
        \put(21,6){\oval(8,3)}
        \put(18.3,5.7){Query Server}
        \put(21,4.5){\vector(0,-1){2}}
        \put(20,1.5){\umlDiamond}
        \put(21,0.5){\line(0,-1){0.5}}
        \put(21,0){\line(-1,0){15}}
        \put(11,0.5){[backup required]}
        \put(6,0){\vector(0,1){4.5}}
        \put(6,6){\oval(8,3)}
        \put(3.3,5.7){Transfer File}
        \put(6,7.5){\vector(0,1){2.5}}
        \put(20,1.5){\line(-1,0){9}}
        \put(11.5,2){[no backup required]}
        \put(11,1.5){\line(0,1){9}}
        \put(11,10.5){\vector(-1,0){4.5}}
    \end{picture}
    \caption{Startup protocol}
    \label{fig:startup-protocol}
\end{figure}

\section{System Evolution}

The following items are points for consideration with regards to the system's
future evolution, and should be seen as likely areas for expansion. The chosen
design should therefore be produced in an open and extensible manner,
especially in the mentioned areas.

\subsection{Cloud Storage/Replication}

It is conceivable that the backup system may replicate to another server, to
ensure that data is not lost in the event of a hardware failure. This
replication may be performed to a host on the same network, or to a cloud
service (such as Amazon S3, for example).

This relates to the archival system in particular, which should be designed in
a such a way that replication is achievable without too much effort.

\subsection{Snapshots}

To provide effective restoration for failed hosts, a feature that allows
administrators to restore a client to a specified date and time could be
implemented.

This would require that the catalog is designed in such a way that the state of
a given file or directory at any point in time can be inferred, so that files
that have since been deleted are restored correctly.

\section{Non Goals}

The system (at least this particular version) will \emph{not} provide the
following features:

\begin{itemize}
    \item Bare-metal disaster recovery for entire operating systems
    \item Cloud support for off-site data storage (e.g. Amazon S3)
\end{itemize}
